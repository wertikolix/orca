name: Release

on:
  push:
    tags:
      - "0.*"
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v5

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses > /dev/null

      - name: Install Android SDK packages
        run: |
          sdkmanager \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Resolve release version
        id: release-version
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="$(./gradlew -q properties | awk '/^version: / {print $2; exit}')"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Resolved release version: ${VERSION}"

      - name: Build tests and release artifacts
        run: ./gradlew --no-daemon --build-cache :orca-core:test :orca-compose-android:testDebugUnitTest :orca-compose-android:assembleRelease :orca-core:jar :sample-app:assembleRelease :sample-app:bundleRelease -PorcaVersion=${{ steps.release-version.outputs.version }}

      - name: Import GPG signing key (optional)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          if [[ -z "${GPG_PRIVATE_KEY}" ]]; then
            echo "No GPG key configured, Maven Central publish will be skipped."
            exit 0
          fi

          GNUPGHOME="$(mktemp -d)"
          chmod 700 "${GNUPGHOME}"
          echo "GNUPGHOME=${GNUPGHOME}" >> "$GITHUB_ENV"

          if ! printf '%s' "${GPG_PRIVATE_KEY}" | gpg --batch --import >/dev/null 2>&1; then
            printf '%s' "${GPG_PRIVATE_KEY}" | base64 --decode | gpg --batch --import
          fi
          if [[ -n "${GPG_PASSPHRASE}" ]]; then
            echo "ORG_GRADLE_PROJECT_signing.gnupg.passphrase=${GPG_PASSPHRASE}" >> "$GITHUB_ENV"
          fi

      - name: Publish to Maven Central (optional)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          CENTRAL_TOKEN_USERNAME: ${{ secrets.CENTRAL_TOKEN_USERNAME }}
          CENTRAL_TOKEN_PASSWORD: ${{ secrets.CENTRAL_TOKEN_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -z "${CENTRAL_TOKEN_USERNAME}" || -z "${CENTRAL_TOKEN_PASSWORD}" || -z "${GNUPGHOME:-}" ]]; then
            echo "Central credentials or signing key are missing, skipping publish."
            exit 0
          fi

          ./gradlew --no-daemon --build-cache \
            :orca-core:publishMavenPublicationToCentralStagingRepository \
            :orca-compose-android:publishReleasePublicationToCentralStagingRepository \
            -PorcaVersion=${{ steps.release-version.outputs.version }} \
            -PcentralTokenUsername=${CENTRAL_TOKEN_USERNAME} \
            -PcentralTokenPassword=${CENTRAL_TOKEN_PASSWORD}

          auth="$(printf '%s' "${CENTRAL_TOKEN_USERNAME}:${CENTRAL_TOKEN_PASSWORD}" | base64 -w0)"
          curl -fsS -X POST \
            -H "Authorization: Bearer ${auth}" \
            "https://ossrh-staging-api.central.sonatype.com/manual/upload/defaultRepository/ru.wertik?publishing_type=automatic"

      - name: Upload release artifacts to workflow
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ github.ref_name }}
          path: |
            orca-compose-android/build/outputs/aar/orca-compose-android-release.aar
            orca-core/build/libs/orca-core*.jar
            sample-app/build/outputs/apk/release/*.apk
            sample-app/build/outputs/bundle/release/*.aab
            sample-app/build/outputs/apk/release/output-metadata.json
          if-no-files-found: error
          retention-days: 14

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          NOTES_FILE="docs/releases/${TAG}.md"

          prerelease_flag=""
          if [[ "$TAG" == *-alpha* || "$TAG" == *-beta* || "$TAG" == *-rc* ]]; then
            prerelease_flag="--prerelease"
          fi

          if ! gh release view "$TAG" >/dev/null 2>&1; then
            if [[ -f "$NOTES_FILE" ]]; then
              gh release create "$TAG" --title "$TAG" $prerelease_flag --notes-file "$NOTES_FILE"
            else
              gh release create "$TAG" --title "$TAG" $prerelease_flag --generate-notes
            fi
          fi

      - name: Upload APK/AAB to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          assets=()

          if [[ -f orca-compose-android/build/outputs/aar/orca-compose-android-release.aar ]]; then
            assets+=(orca-compose-android/build/outputs/aar/orca-compose-android-release.aar)
          fi

          core_jar_files=(orca-core/build/libs/orca-core*.jar)
          for jar in "${core_jar_files[@]}"; do
            [[ -e "$jar" ]] || continue
            if [[ "$jar" == *-sources.jar || "$jar" == *-javadoc.jar ]]; then
              continue
            fi
            assets+=("$jar#orca-core.jar")
            break
          done

          apk_files=(sample-app/build/outputs/apk/release/*.apk)
          if [[ -e "${apk_files[0]}" ]]; then
            assets+=("${apk_files[@]}")
          fi

          aab_files=(sample-app/build/outputs/bundle/release/*.aab)
          if [[ -e "${aab_files[0]}" ]]; then
            assets+=("${aab_files[@]}")
          fi

          if [[ ${#assets[@]} -eq 0 ]]; then
            echo "No release assets found to upload."
            exit 1
          fi

          gh release upload "$TAG" "${assets[@]}" --clobber

      - name: Upload reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: release-failure-reports-${{ github.run_id }}
          path: |
            orca-core/build/reports/
            orca-compose-android/build/reports/
            sample-app/build/reports/
            sample-app/build/outputs/logs/
            build/reports/problems/
          if-no-files-found: ignore
          retention-days: 7
