name: Release

on:
  push:
    tags:
      - "0.*"
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v5

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses > /dev/null

      - name: Install Android SDK packages
        run: |
          sdkmanager \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Resolve release version
        id: release-version
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="$(./gradlew -q properties | awk '/^version: / {print $2; exit}')"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Resolved release version: ${VERSION}"

      - name: Build tests and release artifacts
        run: ./gradlew --no-daemon --build-cache :orca-core:jvmTest :orca-compose:testDebugUnitTest :orca-compose:assembleRelease :orca-core:jvmJar :sample-app:assembleRelease :sample-app:bundleRelease -PorcaVersion=${{ steps.release-version.outputs.version }}

      - name: Prepare signing key for Gradle (optional)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          if [[ -z "${GPG_PRIVATE_KEY}" ]]; then
            echo "No GPG key configured, Maven Central publish will be skipped."
            exit 0
          fi

          key_material="${GPG_PRIVATE_KEY//$'\r'/}"
          if [[ "${key_material}" == *"\\n"* ]]; then
            key_material="${key_material//\\n/$'\n'}"
          fi
          if [[ "${key_material}" != *"BEGIN PGP PRIVATE KEY BLOCK"* ]]; then
            key_material="$(printf '%s' "${key_material}" | base64 --decode)"
          fi

          {
            echo "ORG_GRADLE_PROJECT_signingInMemoryKey<<EOF"
            printf '%s\n' "${key_material}"
            echo "EOF"
            echo "SIGNING_IN_MEMORY_KEY<<EOF"
            printf '%s\n' "${key_material}"
            echo "EOF"
          } >> "$GITHUB_ENV"

          if [[ -n "${GPG_PASSPHRASE}" ]]; then
            echo "ORG_GRADLE_PROJECT_signingInMemoryKeyPassword=${GPG_PASSPHRASE}" >> "$GITHUB_ENV"
            echo "SIGNING_IN_MEMORY_KEY_PASSWORD=${GPG_PASSPHRASE}" >> "$GITHUB_ENV"
          fi

      - name: Publish to Maven Central (optional)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          CENTRAL_TOKEN_USERNAME: ${{ secrets.CENTRAL_TOKEN_USERNAME }}
          CENTRAL_TOKEN_PASSWORD: ${{ secrets.CENTRAL_TOKEN_PASSWORD }}
        run: |
          set -euo pipefail
          if [[ -z "${CENTRAL_TOKEN_USERNAME}" || -z "${CENTRAL_TOKEN_PASSWORD}" ]]; then
            echo "Central credentials are missing, skipping publish."
            exit 0
          fi
          if [[ -z "${ORG_GRADLE_PROJECT_signingInMemoryKey:-}" && -z "${SIGNING_IN_MEMORY_KEY:-}" ]]; then
            echo "Central credentials or signing key are missing, skipping publish."
            exit 0
          fi

          ./gradlew --no-daemon --build-cache \
            :orca-core:publishAllPublicationsToCentralStagingRepository \
            :orca-compose:publishAllPublicationsToCentralStagingRepository \
            -PorcaVersion=${{ steps.release-version.outputs.version }} \
            -PcentralTokenUsername=${CENTRAL_TOKEN_USERNAME} \
            -PcentralTokenPassword=${CENTRAL_TOKEN_PASSWORD}

          # Trigger automatic publishing on the staging repo.
          # The staging repo may not be ready immediately after publish, so retry up to 3 times.
          # If all retries fail we print a warning but do NOT fail the step – the Gradle
          # publish above is the important part.
          auth="$(printf '%s' "${CENTRAL_TOKEN_USERNAME}:${CENTRAL_TOKEN_PASSWORD}" | base64 -w0)"
          publish_url="https://ossrh-staging-api.central.sonatype.com/manual/upload/defaultRepository/ru.wertik?publishing_type=automatic"
          max_attempts=3
          delay=10
          for attempt in $(seq 1 "${max_attempts}"); do
            echo "Attempt ${attempt}/${max_attempts}: POST ${publish_url}"
            if curl -fsS -X POST \
              -H "Authorization: Bearer ${auth}" \
              "${publish_url}"; then
              echo "Automatic publishing triggered successfully."
              break
            else
              echo "::warning::Attempt ${attempt}/${max_attempts} to trigger automatic publishing failed (curl exit code: $?)."
              if [[ "${attempt}" -lt "${max_attempts}" ]]; then
                echo "Retrying in ${delay}s…"
                sleep "${delay}"
              else
                echo "::warning::All ${max_attempts} attempts to trigger automatic publishing failed. The staged artifacts were published to the staging repo by Gradle; you may need to release them manually from the Sonatype UI."
              fi
            fi
          done

      - name: Upload release artifacts to workflow
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ github.ref_name }}
          path: |
            orca-compose/build/outputs/aar/orca-compose-release.aar
            orca-core/build/libs/orca-core*.jar
            sample-app/build/outputs/apk/release/*.apk
            sample-app/build/outputs/bundle/release/*.aab
            sample-app/build/outputs/apk/release/output-metadata.json
          if-no-files-found: error
          retention-days: 14

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          NOTES_FILE="docs/releases/${TAG}.md"

          prerelease_flag=""
          if [[ "$TAG" == *-alpha* || "$TAG" == *-beta* || "$TAG" == *-rc* ]]; then
            prerelease_flag="--prerelease"
          fi

          if ! gh release view "$TAG" >/dev/null 2>&1; then
            if [[ -f "$NOTES_FILE" ]]; then
              gh release create "$TAG" --title "$TAG" $prerelease_flag --notes-file "$NOTES_FILE"
            else
              gh release create "$TAG" --title "$TAG" $prerelease_flag --generate-notes
            fi
          fi

      - name: Upload APK/AAB to GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          assets=()

          if [[ -f orca-compose/build/outputs/aar/orca-compose-release.aar ]]; then
            assets+=(orca-compose/build/outputs/aar/orca-compose-release.aar)
          fi

          core_jar_files=(orca-core/build/libs/orca-core*.jar)
          for jar in "${core_jar_files[@]}"; do
            [[ -e "$jar" ]] || continue
            if [[ "$jar" == *-sources.jar || "$jar" == *-javadoc.jar ]]; then
              continue
            fi
            assets+=("$jar#orca-core.jar")
            break
          done

          apk_files=(sample-app/build/outputs/apk/release/*.apk)
          if [[ -e "${apk_files[0]}" ]]; then
            assets+=("${apk_files[@]}")
          fi

          aab_files=(sample-app/build/outputs/bundle/release/*.aab)
          if [[ -e "${aab_files[0]}" ]]; then
            assets+=("${aab_files[@]}")
          fi

          if [[ ${#assets[@]} -eq 0 ]]; then
            echo "No release assets found to upload."
            exit 1
          fi

          gh release upload "$TAG" "${assets[@]}" --clobber

      - name: Upload reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: release-failure-reports-${{ github.run_id }}
          path: |
            orca-core/build/reports/
            orca-compose/build/reports/
            sample-app/build/reports/
            sample-app/build/outputs/logs/
            build/reports/problems/
          if-no-files-found: ignore
          retention-days: 7
