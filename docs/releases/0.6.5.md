# Orca 0.6.5

Release focus: stability, performance, and dark theme fixes.

## Highlights

- **Thread-safe parser cache**: `OrcaParserCache` is now guarded by a platform-specific lock (JVM `synchronized`, Native `AtomicInt` spinlock, wasmJs no-op). Concurrent `parseCached()` calls no longer risk `ConcurrentModificationException`.
- **Consistent error handling**: `parseCached()` now catches exceptions and returns an empty document, matching `parseWithDiagnostics()` behavior.
- **Recomposition performance**: callback lambdas (`onLinkClick`, `onFootnoteReferenceClick`) are stabilized via `rememberUpdatedState` in `HeadingNode` and `ParagraphNode`, preventing unnecessary `AnnotatedString` rebuilds every frame.
- **COLUMN mode footnote navigation**: footnote reference clicks and back-navigation now work in `OrcaRootLayout.COLUMN` using `BringIntoViewRequester`.
- **Image error fallback**: `AsyncImage` replaced with `SubcomposeAsyncImage` — shows alt text on load failure instead of an empty box.
- **Parse diagnostics on failure**: `onParseDiagnostics` now receives a `ParserFailure` error when parsing throws, instead of an empty diagnostics object.
- **Syntax highlighting performance**: `O(n²)` overlap check replaced with sorted interval list and binary search.
- **Pinned line numbers**: code block line numbers no longer scroll horizontally with code content.
- **Dark style typography**: `darkStyle()` now sets light text colors for headings and paragraphs.
- **Multiple footnote sources**: back-navigation from footnotes uses a stack, correctly returning to the most recent reference source.
- **Correct footnote block targeting**: clicking a footnote reference scrolls to the `Footnotes` block that contains the definition, not always the first one.
- **Stable LazyColumn keys**: block keys are now index-based instead of `hashCode`-based, avoiding collisions and scroll state loss.
- **Relative URL support**: `OrcaSecurityPolicies.byAllowedSchemes()` now accepts `allowRelativeLinks` and `allowRelativeImages` parameters.
- **Front matter fixes**: YAML list item detection narrowed to `"- "` prefix; only one leading newline stripped after closing delimiter.
- **Footnote continuation**: indent stripping extracted into helper for consistency.
- **Consumer ProGuard rules**: `orca-compose` now ships consumer rules for R8/ProGuard.

## API Changes

### `OrcaSecurityPolicies.byAllowedSchemes`

New optional parameters (backward compatible, default `false`):

```kotlin
OrcaSecurityPolicies.byAllowedSchemes(
    linkSchemes = setOf("https"),
    imageSchemes = setOf("https"),
    allowRelativeLinks = true,   // new
    allowRelativeImages = true,  // new
)
```

## Migration from 0.6.4

No breaking changes. All fixes are backward compatible.

## Verification

```bash
./gradlew --no-daemon --build-cache :orca-core:jvmTest :orca-compose:testDebugUnitTest :sample-app:assembleDebug
```
